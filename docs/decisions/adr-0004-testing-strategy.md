# ADR-0004: Стратегия тестирования и Builders (MVP)

- Статус: Accepted
- Дата: 2025-12-28
- Проект: Conwix (conwix-platform)

## 1. Контекст

Проект новый (MVP). Нужно:

- быстро писать тесты без перегруза,
- избегать “раскидывания” тестовых данных,
- использовать реальных сущностей (без mock),
- генерировать сущности через Builders с валидными дефолтами.

## 2. Решение

### 2.1 Слои тестирования

Используются 3 слоя:

1) Unit

- быстрые тесты без БД и без контейнера
- тестируют чистые правила/ValueObjects/чистые сервисы

2) Integration

- тесты с Doctrine и реальной БД
- тестируют репозитории и сервисы, работающие с БД

3) Functional

- тесты HTTP/API через Symfony KernelBrowser
- тестируют контроллеры, роутинг, валидацию, доступы

### 2.2 Структура папок тестов

На старте (без модулей):

app/tests/
Builders/
Shared/
Unit/
Shared/
Integration/
Shared/
Functional/
Shared/
_support/

Когда появятся модули, добавляем:

- app/tests/Builders/Modules/<ModuleName>/
- app/tests/Unit/Modules/<ModuleName>/
- app/tests/Integration/Modules/<ModuleName>/
- app/tests/Functional/Modules/<ModuleName>/

## 3. Правила Builders

### 3.1 Builders обязательны

Сущности в тестах по возможности создаются через Builders.
Builder должен создавать валидную сущность "по умолчанию".

### 3.2 Принцип API Builder

- build() возвращает сущность (без БД)
- withX() позволяет переопределить конкретное поле
- никаких зависимостей от контейнера внутри Builder

### 3.3 Persist отдельно от build (предпочтительно)

В Integration/Functional тестах сохранение в БД делается явно в тесте:

- persist
- flush
- clear (если нужно)

Builder не должен скрывать работу с БД по умолчанию.

## 4. Правила моков

### 4.1 Запрещено мокать

- Entities / ValueObjects
- EntityManager / Doctrine Repository в Integration тестах
- бизнес-правила

### 4.2 Разрешено заменять (mock/fake) только внешние границы

- внешние HTTP API
- LLM/AI клиент
- время/UUID генератор (по необходимости)

Предпочтение: использовать Fake-клиенты вместо моков.

## 5. Последствия

Плюсы:

- тесты читаемы, данные создаются единообразно
- минимум flaky тестов (реальные сущности, минимум моков)
- слои тестов не смешиваются

Минусы:

- Integration тесты требуют поддержки тестовой БД
- нужна дисциплина соблюдения builders-first подхода
