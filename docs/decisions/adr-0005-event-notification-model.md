# ADR-0005: Event & Notification Model (MVP)

- Статус: Accepted
- Дата: 2025-12-28
- Проект: Conwix (conwix-platform)

---

## 1. Контекст

Conwix строится вокруг диалогов, сценариев и автоматизации.  
Для управления системой, предотвращения потерь и повышения контроля необходима
единая **событийная модель (event-driven)** и система уведомлений.

Без зафиксированных правил:

- события начинают дублироваться,
- уведомления становятся хаотичными,
- бизнес-логика расползается по коду.

Цель этого ADR — задать **простую и понятную модель событий и уведомлений для MVP**,
без overengineering и сложных брокеров.

---

## 2. Цели событийной модели

Событийная модель в Conwix нужна для:

- фиксации значимых изменений в системе;
- реакции на поведение клиента или системы;
- триггера уведомлений и автоматизаций;
- отслеживания проблем и отклонений.

События — это **факты**, а не действия.

---

## 3. Определение события (Event)

**Событие (Event)** — это факт, который:

- уже произошёл;
- имеет бизнес-смысл;
- может быть полезен для реакции или анализа.

### Событие ВСЕГДА:

- описывает прошлое (past tense);
- не содержит бизнес-логики;
- не инициирует действия напрямую.

Пример формулировки:

- `MessageReceived`
- `ClientReplied`
- `ConversationIdleExceeded`
- `ScenarioStepCompleted`
- `IntegrationFailed`

---

## 4. Что НЕ является событием (важно)

Событием НЕ является:

- HTTP-запрос;
- команда или действие (`SendMessage`, `CreateClient`);
- внутренняя техническая операция без бизнес-смысла;
- UI-событие (клик, наведение, скролл).

Если это команда — это **не Event**.  
Если это факт — это **Event**.

---

## 5. Классификация событий (MVP)

На старте используются только 3 типа событий:

### 5.1. Domain Events

Факты предметной области:

- сообщение получено;
- клиент ответил;
- сценарий продвинулся.

### 5.2. System Events

Системные факты:

- ошибка интеграции;
- потеря соединения;
- превышение таймаута.

### 5.3. Time-based Events

События, возникшие по времени:

- клиент не ответил N минут;
- диалог простаивает;
- SLA превышен.

---

## 6. Хранение событий

В MVP:

- события **логируются** и/или **передаются в обработчики**;
- не строится отдельный event store;
- события могут храниться:
  - в таблице БД (если нужно для аудита),
  - в логах,
  - в памяти (для реакций).

Событие — **immutable** (не изменяется после создания).

---

## 7. Реакция на события

### 7.1. Обработчики событий (Handlers)

- событие может иметь 0, 1 или несколько обработчиков;
- обработчик:
  - читает событие,
  - принимает решение,
  - инициирует действия (уведомление, автоматизацию).

Событие **ничего не знает** о том, кто его обрабатывает.

---

## 8. Уведомления (Notifications)

**Уведомление** — это реакция на событие.

Уведомления могут быть:

- внутренними (для пользователей системы);
- внешними (для клиентов);
- системными (логи, алерты).

Уведомление:

- не является событием;
- не порождает новых событий автоматически (если не зафиксировано отдельно).

---

## 9. Когда отправлять уведомления

Уведомления отправляются только если:

- событие значимо для реакции;
- уведомление предотвращает потерю или ускоряет действие;
- уведомление можно объяснить пользователю.

Запрещено:

- уведомлять “на всё подряд”;
- дублировать уведомления без причины;
- отправлять уведомления без контроля частоты.

---

## 10. Каналы уведомлений (MVP)

На старте допустимы:

- UI-уведомления (в интерфейсе);
- Email;
- Messenger-уведомления (если это core-сценарий).

Добавление нового канала:

- только при наличии реального кейса;
- фиксируется отдельным ADR при необходимости.

---

## 11. Связь с автоматизацией

События могут использоваться:

- как триггеры сценариев (BotFlow);
- как условия автоматизации;
- как входные данные для AI-анализа.

Автоматизация:

- должна быть управляемой;
- должна быть отключаемой;
- не должна скрывать логику принятия решений.

---

## 12. Anti-goals (ограничения)

В рамках MVP:

- не используется сложный message broker;
- не строится полноценный event sourcing;
- не делается универсальный rule-engine;
- не вводится “магическая” автоматизация без объяснений.

---

## 13. Последствия

### Плюсы

- единая логика работы с событиями;
- понятные точки расширения;
- контроль над уведомлениями и автоматизацией.

### Минусы

- часть логики будет синхронной;
- масштабирование event-модели потребует эволюции в будущем.

---

## 14. Связанные документы

- Project Reset v1.3
- ADR-0004: Testing Strategy
- Anti-goals (Project Reset)
