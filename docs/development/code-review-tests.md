# Checklist Code Review — Tests (Conwix)

Этот чеклист используется при ревью **всех тестов** в проекте Conwix.  
Цель: сохранить тесты читаемыми, детерминированными и соответствующими принципу **builders-first, минимум mock, MVP-speed**.

Если пункт чеклиста нарушен — в PR должно быть короткое объяснение (1–2 строки), почему это допустимо.

---

## 0. Базовые требования

- [ ] Тесты добавлены или обновлены вместе с изменениями кода.
- [ ] Название теста описывает **поведение**, а не реализацию.
- [ ] Тест независим от порядка выполнения других тестов.

---

## 1. Слой тестирования

- [ ] Тест размещён в корректном слое:
  - [ ] `Unit/` — без БД, без Symfony Container
  - [ ] `Integration/` — с Doctrine/БД и/или контейнером
  - [ ] `Functional/` — HTTP/API (KernelBrowser)
- [ ] В `Unit/` тестах отсутствуют:
  - обращения к БД
  - обращения к контейнеру
  - файловая система
  - сеть

---

## 2. Builders-first (обязательное правило)

- [ ] Сущности создаются через Builder (или есть аргументированное исключение).
- [ ] Builder создаёт **валидную сущность по умолчанию**.
- [ ] В тесте переопределены только необходимые поля через `withX()`.
- [ ] Builder **не использует** `EntityManager`, `Container`, сервисы.
- [ ] В Builder нет `persist()` или скрытой работы с БД по умолчанию.
- [ ] Значения по умолчанию:
  - реалистичные
  - стабильные
  - без `rand()` и нестабильных генераторов

---

## 3. Моки и фейки

- [ ] Сущности и ValueObject **не мокируются**.
- [ ] В `Integration/` тестах **не мокируются**:
  - `EntityManager`
  - Doctrine `Repository`
- [ ] Моки/фейки используются **только** для внешних границ:
  - [ ] внешние HTTP API
  - [ ] LLM / AI клиент
  - [ ] время / UUID генератор (если требуется)
- [ ] Используется **Fake**, если это возможно, вместо сложного mock.
- [ ] Mock не проверяет внутреннюю реализацию (минимум `expects()`).

---

## 4. Читаемость теста

- [ ] Тест читается как сценарий: **Arrange → Act → Assert**.
- [ ] В тесте нет лишних деталей, не влияющих на проверяемое поведение.
- [ ] Подготовка данных прозрачна и очевидна.
- [ ] Ассерты проверяют результат/поведение, а не промежуточные детали.

---

## 5. Детерминизм и стабильность

- [ ] Тест не зависит от:
  - текущей даты
  - времени
  - таймзоны
- [ ] Если используется время — применяется фиксированный Clock/FakeClock.
- [ ] Тест не зависит от внешних сервисов или сети.
- [ ] Тест стабилен при повторных запусках.

---

## 6. Работа с БД (Integration / Functional)

- [ ] Данные создаются в тесте явно (Builders + `persist/flush`).
- [ ] Тест изолирован:
  - транзакция
  - или очистка данных между тестами
- [ ] Проверяются только значимые для поведения поля.
- [ ] Добавлен минимум один негативный кейс там, где это критично.

---

## 7. Покрытие рисков (MVP-фокус)

- [ ] Тесты покрывают ключевые бизнес-риски.
- [ ] Functional тесты добавлены только для критических сценариев.
- [ ] Нет дублирования проверки одной и той же логики на разных уровнях без причины.

---

## 8. Ошибки и исключения

- [ ] Проверены важные ошибки и отказные сценарии.
- [ ] Коды ошибок / сообщения проверяются только там, где это действительно важно.
- [ ] Нет избыточных проверок “на всякий случай”.

---

## 9. Производительность тестов

- [ ] Unit тесты выполняются быстро (без I/O).
- [ ] Integration тесты не делают лишних `flush()` и пересозданий данных.
- [ ] Functional тесты не дублируют проверки из Integration.

---

## 10. Правило исключений

Если какой-либо пункт чеклиста нарушен:

- [ ] В PR есть короткое объяснение причины.
- [ ] Исключение осознанное и временное (если применимо).
