services:
    traefik:
        image: traefik:v3.1
        command:
            - --providers.docker=true
            - --providers.docker.exposedbydefault=false
            - --entrypoints.web.address=:80
        ports:
            - "80:80"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
        networks:
            - edge
        restart: unless-stopped

    app-nginx:
        image: nginx:1.27-alpine
        depends_on:
            - app-php-fpm
        volumes:
            - ../app/public:/var/www/app/public:ro
            - ../app/docker/nginx:/etc/nginx/conf.d:ro
        labels:
            - traefik.enable=true
            - traefik.docker.network=edge
            - traefik.http.routers.app.rule=Host(`conwix.local`)
            - traefik.http.routers.app.entrypoints=web
            - traefik.http.services.app.loadbalancer.server.port=80
        networks:
            - edge
            - internal
        restart: unless-stopped

    app-php-fpm:
        build:
            context: ..
            dockerfile: app/docker/php/Dockerfile.fpm
        volumes:
            - ../app:/var/www/app
        environment:
            APP_ENV: dev
            APP_DEBUG: "1"
            DATABASE_URL: postgresql://app:app@app-postgres:5432/app?serverVersion=16&charset=utf8
            REDIS_URL: redis://app-redis:6379
        networks:
            - internal
        restart: unless-stopped

    # CLI используется через `docker compose run --rm app-php-cli ...`
    app-php-cli:
        build:
            context: ..
            dockerfile: app/docker/php/Dockerfile.cli
        volumes:
            - ../app:/var/www/app
        environment:
            APP_ENV: dev
            APP_DEBUG: "1"
            DATABASE_URL: postgresql://app:app@app-postgres:5432/app?serverVersion=16&charset=utf8
            REDIS_URL: redis://app-redis:6379
        networks:
            - internal

    app-postgres:
        image: postgres:16-alpine
        environment:
            POSTGRES_DB: app
            POSTGRES_USER: app
            POSTGRES_PASSWORD: app
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U app -d app"]
            interval: 2s
            timeout: 2s
            retries: 60
        networks:
            - internal
        restart: unless-stopped

    app-redis:
        image: redis:7-alpine
        command: ["redis-server", "--appendonly", "yes"]
        volumes:
            - redis_data:/data
        networks:
            - internal
        restart: unless-stopped

networks:
    edge:
    internal:

volumes:
    postgres_data:
    redis_data:
